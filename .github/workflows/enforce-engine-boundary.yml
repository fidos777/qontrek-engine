name: Enforce Engine Boundaries

# Prevents engine logic from leaking into frontend/shell repositories
# Enforces: SHARED_ENGINE_LAW.md "What Lives Here (ONLY HERE)"
# Authority: SHARED_ENGINE_LAW.md, GOVERNANCE_INDEX.md

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]

env:
  # Set to 'true' for repos that ARE the engine (skip checks)
  IS_ENGINE_REPO: 'false'

jobs:
  boundary-check:
    name: Check Engine Boundary Compliance
    runs-on: ubuntu-latest
    
    # Skip this check for the engine repo itself
    if: ${{ github.repository != 'your-org/qontrek-engine' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for engine logic violations
        run: |
          echo "ğŸ” Scanning for engine logic in non-engine repository..."
          echo ""
          
          VIOLATIONS_FOUND=0
          VIOLATION_FILES=""
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Pattern 1: Credit Engine Logic
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "Checking for Credit Engine logic..."
          
          CREDIT_PATTERNS=(
            "creditEngine"
            "CreditEngine"
            "credit_engine"
            "validateCredit"
            "lockCredit"
            "consumeCredit"
            "rollbackCredit"
            "CREDIT_STATE"
            "CreditStateMachine"
          )
          
          for PATTERN in "${CREDIT_PATTERNS[@]}"; do
            MATCHES=$(grep -r --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
                          -l "$PATTERN" . 2>/dev/null | grep -v node_modules | grep -v ".github" || true)
            if [ -n "$MATCHES" ]; then
              echo "âŒ Found '$PATTERN' in:"
              echo "$MATCHES" | while read file; do echo "   - $file"; done
              VIOLATION_FILES="$VIOLATION_FILES $MATCHES"
              VIOLATIONS_FOUND=1
            fi
          done
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Pattern 2: Workflow Runtime Logic
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo ""
          echo "Checking for Workflow Runtime logic..."
          
          WORKFLOW_PATTERNS=(
            "workflowRuntime"
            "WorkflowRuntime"
            "workflow_runtime"
            "executeWorkflow"
            "runWorkflow"
            "WorkflowExecutor"
          )
          
          for PATTERN in "${WORKFLOW_PATTERNS[@]}"; do
            MATCHES=$(grep -r --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
                          -l "$PATTERN" . 2>/dev/null | grep -v node_modules | grep -v ".github" || true)
            if [ -n "$MATCHES" ]; then
              echo "âŒ Found '$PATTERN' in:"
              echo "$MATCHES" | while read file; do echo "   - $file"; done
              VIOLATION_FILES="$VIOLATION_FILES $MATCHES"
              VIOLATIONS_FOUND=1
            fi
          done
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Pattern 3: Persona/Skill Logic
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo ""
          echo "Checking for Persona/Skill logic..."
          
          PERSONA_PATTERNS=(
            "personaRegistry"
            "PersonaRegistry"
            "persona_registry"
            "skillRegistry"
            "SkillRegistry"
            "skill_registry"
            "registerPersona"
            "registerSkill"
          )
          
          for PATTERN in "${PERSONA_PATTERNS[@]}"; do
            MATCHES=$(grep -r --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
                          -l "$PATTERN" . 2>/dev/null | grep -v node_modules | grep -v ".github" || true)
            if [ -n "$MATCHES" ]; then
              echo "âŒ Found '$PATTERN' in:"
              echo "$MATCHES" | while read file; do echo "   - $file"; done
              VIOLATION_FILES="$VIOLATION_FILES $MATCHES"
              VIOLATIONS_FOUND=1
            fi
          done
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Pattern 4: Proof Fabric Logic
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo ""
          echo "Checking for Proof Fabric logic..."
          
          PROOF_PATTERNS=(
            "proofFabric"
            "ProofFabric"
            "proof_fabric"
            "generateProofId"
            "generate_proof_id"
            "writeProof"
          )
          
          for PATTERN in "${PROOF_PATTERNS[@]}"; do
            MATCHES=$(grep -r --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
                          -l "$PATTERN" . 2>/dev/null | grep -v node_modules | grep -v ".github" || true)
            if [ -n "$MATCHES" ]; then
              echo "âŒ Found '$PATTERN' in:"
              echo "$MATCHES" | while read file; do echo "   - $file"; done
              VIOLATION_FILES="$VIOLATION_FILES $MATCHES"
              VIOLATIONS_FOUND=1
            fi
          done
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Pattern 5: Direct Execution (Bypass Attempt)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo ""
          echo "Checking for direct execution patterns..."
          
          EXECUTION_PATTERNS=(
            "execution_context"
            "executionContext"
            "ExecutionContext"
          )
          
          for PATTERN in "${EXECUTION_PATTERNS[@]}"; do
            MATCHES=$(grep -r --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
                          -l "$PATTERN" . 2>/dev/null | grep -v node_modules | grep -v ".github" | grep -v "types" | grep -v ".d.ts" || true)
            if [ -n "$MATCHES" ]; then
              echo "âš ï¸  Found '$PATTERN' in (review required):"
              echo "$MATCHES" | while read file; do echo "   - $file"; done
              # Note: This is a warning, not automatic failure
              # execution_context might be passed through, not created
            fi
          done
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Final Report
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo ""
          if [ $VIOLATIONS_FOUND -eq 1 ]; then
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ VIOLATION: Engine Logic Detected Outside Engine"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This violates the Shared Engine Law."
            echo ""
            echo "The following MUST live ONLY in qontrek-engine:"
            echo "  â€¢ Credit Engine (validation, locking, consumption)"
            echo "  â€¢ Workflow Runtime (execution, timeout, failure)"
            echo "  â€¢ Persona/Skill Layer (configuration, MCP bindings)"
            echo "  â€¢ Proof Fabric (logs, proof_id generation)"
            echo ""
            echo "Frontend/shell repos should:"
            echo "  â€¢ Call engine via API"
            echo "  â€¢ NOT contain execution logic"
            echo "  â€¢ NOT duplicate engine code"
            echo ""
            echo "See SHARED_ENGINE_LAW.md for details."
            echo "See GOVERNANCE_INDEX.md for authority hierarchy."
            echo ""
            echo "Violation = Bug"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            echo "âœ… No engine logic violations found"
          fi

      - name: Report success
        if: success()
        run: |
          echo "âœ… Engine boundary enforcement passed"
          echo "This repository correctly delegates to qontrek-engine via API"
